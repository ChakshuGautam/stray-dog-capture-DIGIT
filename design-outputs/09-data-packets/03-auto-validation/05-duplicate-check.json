{
  "_meta": {
    "stage": "03-auto-validation",
    "step": 5,
    "description": "Check for duplicate images using perceptual hash comparison",
    "sender": "SDCRS Validator",
    "receiver": "Elasticsearch (image hash index)",
    "trigger": "Boundary validation complete",
    "previousPacket": "04-boundary-validation.json",
    "nextPacket": "06-fraud-score-request.json",
    "verified": true,
    "source": "Evidence.java - imageHash field (pHash, 64 chars)"
  },
  "duplicateCheckRequest": {
    "method": "POST",
    "url": "http://elasticsearch.backbone:9200/sdcrs-evidence-v1/_search",
    "body": {
      "query": {
        "bool": {
          "must": [
            {
              "range": {
                "createdTime": {
                  "gte": "now-30d"
                }
              }
            }
          ],
          "filter": [
            {
              "term": {
                "tenantId": "dj.djibouti-ville"
              }
            },
            {
              "term": {
                "evidenceType": "DOG_PHOTO"
              }
            }
          ]
        }
      },
      "_source": ["reportId", "imageHash", "createdTime"],
      "size": 100
    }
  },
  "hashComparison": {
    "currentImageHash": "d4c3b2a1e5f6789012345678901234567890123456789012345678901234",
    "algorithm": "pHash",
    "similarityThreshold": 0.90,
    "comparedHashes": [
      {
        "reportId": "dr-uuid-old-001",
        "imageHash": "a1b2c3d4e5f6789012345678901234567890123456789012345678901234",
        "similarity": 0.45,
        "isDuplicate": false
      },
      {
        "reportId": "dr-uuid-old-002",
        "imageHash": "e5f6g7h8i9j0123456789012345678901234567890123456789012345678",
        "similarity": 0.32,
        "isDuplicate": false
      }
    ]
  },
  "result": {
    "passed": true,
    "duplicateFound": false,
    "highestSimilarity": 0.45,
    "reason": "No duplicate images found above 90% threshold"
  },
  "failureScenario": {
    "_comment": "Duplicate image found",
    "comparedHash": {
      "reportId": "dr-uuid-duplicate",
      "reportNumber": "DR-DJ-2024-000100",
      "similarity": 0.94
    },
    "result": {
      "passed": false,
      "duplicateFound": true,
      "duplicateReportNumber": "DR-DJ-2024-000100",
      "reason": "94% similar image found in report DR-DJ-2024-000100"
    },
    "rejectionReason": "DUPLICATE_IMAGE"
  }
}
